<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nikita & Kevin's Nyombo - QR Code</title>
    <link rel="icon" type="image/svg+xml" href="/icon.svg">
    <!-- Using QR Server API instead of external JS library -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #000000, #1a1a1a);
            color: #fbbf24;
            margin: 0;
            padding: 40px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            background: linear-gradient(135deg, #1f2937, #111827);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            border: 3px solid #fbbf24;
            text-align: center;
            max-width: 600px;
            width: 100%;
        }
        
        .title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #fbbf24, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #fde68a;
            margin-bottom: 30px;
        }
        
        .date {
            font-size: 1.5rem;
            color: #fbbf24;
            margin-bottom: 30px;
            font-weight: bold;
        }
        
        .qr-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
            display: inline-block;
            border: 2px solid #fbbf24;
        }
        
        .qr-code {
            display: block;
            margin: 0 auto;
        }
        
        .instructions {
            color: #d1d5db;
            font-size: 1rem;
            line-height: 1.6;
            margin-top: 20px;
        }
        
        .website-url {
            color: #fbbf24;
            font-weight: bold;
            word-break: break-all;
            margin: 15px 0;
            padding: 10px;
            background: rgba(251, 191, 36, 0.1);
            border-radius: 8px;
            border: 1px solid #fbbf24;
        }
        
        .print-button {
            background: linear-gradient(45deg, #fbbf24, #f59e0b);
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s;
        }
        
        .print-button:hover {
            transform: scale(1.05);
        }
        
        @media print {
            body {
                background: white !important;
                color: black !important;
                margin: 0;
                padding: 20px;
                font-size: 14pt;
            }
            
            .container {
                background: white !important;
                border: none !important;
                box-shadow: none !important;
                max-width: 100% !important;
                margin: 0 auto;
                padding: 5px;
                page-break-inside: avoid;
                text-align: center;
                width: 100%;
            }
            
            .title {
                color: #000 !important;
                -webkit-text-fill-color: #000 !important;
                font-size: 18pt;
                margin-bottom: 5px;
            }
            
            .subtitle {
                color: #333 !important;
                font-size: 12pt;
                margin-bottom: 8px;
            }
            
            .date {
                color: #333 !important;
                font-size: 14pt;
                margin-bottom: 10px;
            }
            
            .qr-container {
                background: white !important;
                border: none !important;
                padding: 0px;
                margin: 5px auto;
                page-break-inside: avoid;
                width: 300px !important;
                text-align: center;
                display: block;
            }
            
            .qr-code {
                width: 300px !important;
                height: 300px !important;
                max-width: 100%;
                display: block;
                margin: 0 auto;
                text-align: center;
            }
            
            .instructions {
                color: #333 !important;
                font-size: 8pt;
                line-height: 1.1;
                margin-top: 8px;
            }
            
            .website-url {
                color: #000 !important;
                background: #f5f5f5 !important;
                border: none !important;
                font-size: 7pt;
                padding: 2px;
                margin: 3px 0;
                word-break: break-all;
                line-height: 1.1;
            }
            
            .print-button {
                display: none !important;
            }
            
            /* Minimal margins for single page fit */
            @page {
                margin: 0.25in;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title"># Nyombo</h1>
        <p class="subtitle">Nikita & Kevin's Traditional Ceremony</p>
        <p class="date">15.11.2025</p>
        
        <div class="qr-container">
            <img id="qr-code" class="qr-code" alt="QR Code" style="width: 300px; height: 300px; max-width: 100%;">
        </div>
        
        <div class="website-url" id="website-url">
            Loading...
        </div>
        
        <div class="instructions">
            <p><strong>Scan this QR code to visit our Nyombo website!</strong></p>
            <p>Share your photos, leave well wishes, and join us in celebrating our special day.</p>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
            <button class="print-button" onclick="window.print()">
                üìÑ Print / Save as PDF
            </button>
            <button class="print-button" id="pdfButton" onclick="saveAsPDF()">
                üìÑ Save as PDF
            </button>
            <button class="print-button" id="jpgButton" onclick="saveAsJPG()">
                üñºÔ∏è Save as JPG
            </button>
        </div>
        <div id="loadingMessage" style="display: none; text-align: center; margin-top: 10px; color: #fbbf24;">
            Generating file... Please wait
        </div>
    </div>

    <script>
        // Generate QR code using QR Server API (no external dependencies)
        function generateQRCode() {
            // Get the current website URL
            const websiteUrl = window.location.origin;
            
            // Update the URL display
            document.getElementById('website-url').textContent = websiteUrl;
            
            // Generate QR code using QR Server API
            const qrCodeImg = document.getElementById('qr-code');
            const encodedUrl = encodeURIComponent(websiteUrl);
            
            // Use QR Server API with high quality settings for printing
            qrCodeImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=${encodedUrl}&format=png&ecc=H&margin=15&color=000000&bgcolor=FFFFFF`;
            
            // Handle image load success
            qrCodeImg.onload = function() {
                console.log('QR Code generated successfully!');
                document.getElementById('website-url').style.color = '#fbbf24';
            };
            
            // Handle image load error
            qrCodeImg.onerror = function() {
                console.error('QR Code generation failed');
                document.getElementById('website-url').innerHTML = 
                    '<p style="color: red;">QR Code generation failed. Please refresh the page.</p>';
            };
        }
        
        // Generate QR code when page loads
        window.addEventListener('load', generateQRCode);
        
        // Also try immediately in case load event already fired
        if (document.readyState === 'complete') {
            generateQRCode();
        }
        
        // Function to save as JPG
        function saveAsJPG() {
            // Show loading message and disable button
            const jpgButton = document.getElementById('jpgButton');
            const loadingMessage = document.getElementById('loadingMessage');
            jpgButton.disabled = true;
            jpgButton.textContent = '‚è≥ Generating JPG...';
            loadingMessage.style.display = 'block';
            
            // Get the container element
            const container = document.querySelector('.container');
            
            // Wait for QR code to load, then capture
            const qrImg = document.getElementById('qr-code');
            
            // Function to capture after QR code is loaded
            function captureImage() {
                if (typeof html2canvas !== 'undefined') {
                    html2canvas(container, {
                        backgroundColor: '#ffffff',
                        scale: 2, // Higher quality
                        useCORS: true,
                        allowTaint: true,
                        foreignObjectRendering: true,
                        logging: false,
                        imageTimeout: 15000, // Wait longer for images
                        onclone: function(clonedDoc) {
                            // Ensure QR code is visible in cloned document
                            const clonedQrImg = clonedDoc.getElementById('qr-code');
                            if (clonedQrImg && qrImg.src) {
                                clonedQrImg.src = qrImg.src;
                            }
                        }
                    }).then(function(canvas) {
                        // Convert canvas to JPG
                        const link = document.createElement('a');
                        link.download = 'nikita-kevin-nyombo-qr-code.jpg';
                        link.href = canvas.toDataURL('image/jpeg', 0.9);
                        link.click();
                        
                        // Reset button and hide loading message
                        jpgButton.disabled = false;
                        jpgButton.textContent = 'üñºÔ∏è Save as JPG';
                        loadingMessage.style.display = 'none';
                    }).catch(function(error) {
                        console.error('Error capturing image:', error);
                        alert('Error capturing image. Please try again.');
                        
                        // Reset button and hide loading message
                        jpgButton.disabled = false;
                        jpgButton.textContent = 'üñºÔ∏è Save as JPG';
                        loadingMessage.style.display = 'none';
                    });
                } else {
                    // Fallback: Load html2canvas from CDN
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
                    script.onload = function() {
                        captureImage();
                    };
                    document.head.appendChild(script);
                }
            }
            
            // Check if QR code is loaded
            if (qrImg.complete && qrImg.naturalHeight !== 0) {
                captureImage();
            } else {
                // Wait for QR code to load
                qrImg.onload = function() {
                    setTimeout(captureImage, 500); // Small delay to ensure rendering
                };
            }
        }

        // Function to save as PDF
        function saveAsPDF() {
            const pdfButton = document.getElementById('pdfButton');
            const loadingMessage = document.getElementById('loadingMessage');
            pdfButton.disabled = true;
            pdfButton.textContent = '‚è≥ Generating PDF...';
            loadingMessage.style.display = 'block';

            const container = document.querySelector('.container');
            const qrImg = document.getElementById('qr-code');

            function captureAndCreatePDF() {
                if (typeof html2canvas !== 'undefined' && window.jspdf) {
                    html2canvas(container, {
                        backgroundColor: '#ffffff',
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        foreignObjectRendering: true,
                        logging: false,
                        imageTimeout: 15000,
                        onclone: function(clonedDoc) {
                            const clonedQrImg = clonedDoc.getElementById('qr-code');
                            if (clonedQrImg && qrImg.src) {
                                clonedQrImg.src = qrImg.src;
                            }
                        }
                    }).then(function(canvas) {
                        const imgData = canvas.toDataURL('image/jpeg', 0.95);
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF('p', 'mm', 'a4');

                        const pageWidth = pdf.internal.pageSize.getWidth();
                        const pageHeight = pdf.internal.pageSize.getHeight();
                        const margin = 10; // mm

                        // Convert canvas pixels to mm at ~96 DPI: 1 inch = 25.4 mm, 96 px = 25.4 mm
                        const pxToMm = 25.4 / 96;
                        const imgWidthMm = canvas.width * pxToMm / 2;  // divide by 2 due to scale: 2
                        const imgHeightMm = canvas.height * pxToMm / 2;

                        // Fit within page while preserving aspect ratio
                        const maxWidth = pageWidth - margin * 2;
                        const maxHeight = pageHeight - margin * 2;
                        let renderWidth = imgWidthMm;
                        let renderHeight = imgHeightMm;
                        const widthRatio = maxWidth / imgWidthMm;
                        const heightRatio = maxHeight / imgHeightMm;
                        const ratio = Math.min(widthRatio, heightRatio, 1);
                        renderWidth = imgWidthMm * ratio;
                        renderHeight = imgHeightMm * ratio;

                        const x = (pageWidth - renderWidth) / 2;
                        const y = (pageHeight - renderHeight) / 2;

                        pdf.addImage(imgData, 'JPEG', x, y, renderWidth, renderHeight);
                        pdf.save('nikita-kevin-nyombo-qr-code.pdf');

                        pdfButton.disabled = false;
                        pdfButton.textContent = 'üìÑ Save as PDF';
                        loadingMessage.style.display = 'none';
                    }).catch(function(error) {
                        console.error('Error generating PDF:', error);
                        alert('Error generating PDF. Please try again.');
                        pdfButton.disabled = false;
                        pdfButton.textContent = 'üìÑ Save as PDF';
                        loadingMessage.style.display = 'none';
                    });
                } else {
                    // Load dependencies if missing
                    const scripts = [];
                    if (typeof html2canvas === 'undefined') {
                        const s1 = document.createElement('script');
                        s1.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
                        scripts.push(new Promise(res => { s1.onload = res; document.head.appendChild(s1); }));
                    }
                    if (!window.jspdf) {
                        const s2 = document.createElement('script');
                        s2.src = 'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';
                        scripts.push(new Promise(res => { s2.onload = res; document.head.appendChild(s2); }));
                    }
                    Promise.all(scripts).then(captureAndCreatePDF);
                }
            }

            if (qrImg.complete && qrImg.naturalHeight !== 0) {
                captureAndCreatePDF();
            } else {
                qrImg.onload = function() {
                    setTimeout(captureAndCreatePDF, 500);
                };
            }
        }
    </script>
</script>
</body>
</html>

